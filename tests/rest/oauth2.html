<!DOCTYPE html>
<!--
This page shows how to use Jorani as an OAuth2 identity provider
http://localhost/jorani/tests/rest/oauth2.html
-->
<html>
    <head>
        <title>OAuth2 Identity Provider</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href="../../assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
        <link href="../../assets/css/jorani-0.5.1.css" rel="stylesheet" type="text/css"/>
        <script src="../../assets/js/jquery-2.2.4.min.js" type="text/javascript"></script>
        <script src="../../assets/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
        <script src="../../assets/js/bootbox.min.js" type="text/javascript"></script>
    </head>
    <body>  
        <div class="container">
            <h1>Prerequisites</h1>

            <p>Make sure that you've inserted the <code>demo-login-oauth2</code> client into 
                the database (or by using Jorani webui with admin/oauth):</p>
            <pre>INSERT INTO oauth_clients (client_id, client_secret, redirect_uri) VALUES ("demo-login-oauth2", "", "http://localhost/jorani/tests/rest/oauth2.html");</pre>
            
            <p>The <code>redirect_uri</code> must match with the current page.</p>

            <p>You must use a valid user from Jorani (i.e. use a user that exists into the database).</p>
            
            <p>Optionally, an image with the same name than the client_id (and a PNG extension) can be added to the local folder.</p>

            <h1>Try to authorize the application</h1>

            <button id="cmdAuthorize" class="btn btn-primary"><i class="icon-user icon-white"></i>&nbsp;Who am I?</button>

        </div>
        
<div class="modal hide" id="frmAuthorize" data-backdrop="static" data-keyboard="false">
    <div class="modal-header">
        <a href="#" onclick="$('#frmAuthorize').modal('hide');" class="close">&times;</a>
        <h3>Authorization</h3>
    </div>
    <div class="modal-body" id="frmAuthorizeBody" style="overflow-x: hidden;">
        <img src="../../assets/images/loading.gif" align="middle" />
    </div>
    <div class="modal-footer">
        <button onclick="$('#frmAuthorize').modal('hide');" class="btn">Cancel</button>
    </div>
</div>

<script type="text/javascript">
var host = "http://localhost/jorani/api/";
var baseUrl = host + "authorization/authorize";
var clientId = "demo-login-oauth2";

//Try to authorize the application
function JoraniOAuthTry() {
    $.ajax({
        url: baseUrl,
        type: "GET",
        data: {
            client_id: clientId,
            response_type: "code",
            state: "xyz",
        },
        success: function(response, status, xhr){
            var ct = xhr.getResponseHeader("content-type") || "";
            if (ct.indexOf('html') > -1) {
                $("#frmAuthorize").modal('show');
                $("#frmAuthorizeBody").html(response);
            }
            if (ct.indexOf('plain') > -1) {
                JoraniOAuthAuthorizedCallback(response);
            }
        }
    });
}

//This function is triggered on a successful login
//We need to reload the view so as to display the accept form
function JoraniOAuthLoginCallback() {
    JoraniOAuthTry();
}

//This function is triggered when a user refuses to associate the application
function JoraniOAuthCancelCallback() {
    $('#frmAuthorize').modal('hide');
    bootbox.alert("Not authorized");
}

//This function is triggered when the applications are authorized
function JoraniOAuthAuthorizedCallback(data) {
    //We can now get an OAuth2 token using the temporary authorization code
    var query = host + "token";
    $.ajax({
        url: query,
        type: "POST",
        data: {
            client_id: clientId,
            grant_type: "authorization_code",
            code: data,
        },
        success: function(data){
            //Now that we got an OAuth2 access token, we can access to the user properties
            var query = host + "authorization/userinfo";
            $.ajax({
                url: query,
                type: "POST",
                data: {
                    client_id: clientId,
                    access_token: data.access_token,
                },
                success: function(data){
                    $('#frmAuthorize').modal('hide');
                    bootbox.alert("Hello " + data.firstname + " " + data.lastname);
                }
            });
        }
    });
}

$(function () {
    $("#cmdAuthorize").click(function() {
        JoraniOAuthTry();
    });
});
</script>
    </body>
</html>
